<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Tiny World Simplified</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background-color: #f5f5f5;
        }
        #characterSelectScreen, #battleScreen, #shopScreen {
            display: none;
            flex: 1;
            flex-direction: column;
            padding: 20px;
            position: relative;
        }
        #characterSelectScreen {
            text-align: center;
            justify-content: center;
            align-items: center;
            display: flex;
            gap: 40px;
        }
        #gameTitle {
            margin: 0;
            margin-bottom: 20px;
            font-size: 2em;
            color: #333;
        }
        #battleScreen {
            position: relative;
        }
        #enemyStats {
            flex: 0 0 50%;
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #ccc;
            font-size: 1.5em;
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #playerSection {
            flex: 0 0 50%;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: flex-start;
            padding: 20px;
            gap: 20px;
        }
        #playerStats {
            flex: 0 0 25%;
            font-size: 1.2em;
            text-align: left;
            padding: 15px;
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #handAndActions {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #actionButtons {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        #hand, #shopHand {
            font-size: 1.2em;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }
        .gem {
            display: inline-block;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            background-color: #f0f0f0;
            transition: transform 0.2s;
        }
        .gem.red { background-color: #ffcccc; }
        .gem.blue { background-color: #cce5ff; }
        .gem.green { background-color: #ccffcc; }
        .gem.grey { background-color: #e0e0e0; }
        .gem:hover { transform: scale(1.05); }
        .gem.selected { border: 2px solid black; }
        button {
            padding: 10px 20px;
            cursor: pointer;
            font-size: 1em;
            transition: transform 0.2s, background-color 0.2s, opacity 0.2s;
            border: none;
            border-radius: 5px;
            background-color: #ddd;
        }
        button:hover {
            transform: scale(1.1);
            background-color: #e0e0e0;
        }
        button:disabled {
            opacity: 0.3;
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        #knightBtn { background-color: #ff9999; }
        #knightBtn:hover { background-color: #ff6666; }
        #mageBtn { background-color: #99ccff; }
        #mageBtn:hover { background-color: #66b3ff; }
        #rogueBtn { background-color: #99ff99; }
        #rogueBtn:hover { background-color: #66ff66; }
        #deckSizeIndicator {
            position: absolute;
            bottom: 20px;
            right: 20px;
            font-size: 2em;
            color: #333;
        }
        #shopScreen {
            justify-content: center;
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin: 20px;
        }
        #shopSelections {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            padding: 20px;
        }
        #shopZenny, #shopHealth, #shopDeckInfo {
            position: absolute;
            font-size: 1.5em;
            color: #333;
        }
        #shopZenny { left: 20px; bottom: 20px; }
        #shopHealth { top: 20px; left: 20px; }
        #shopDeckInfo { top: 20px; right: 20px; }
        #upgradeOptions {
            display: flex;
            gap: 20px;
        }
        #message {
            text-align: center;
            font-weight: bold;
            color: #d32f2f;
            margin: 10px 0;
            padding: 10px;
            background-color: #ffebee;
            border-radius: 5px;
        }
        #bossCondition {
            font-style: italic;
            color: #666;
        }
        #waitBuffIndicator {
            font-style: italic;
            color: #006600;
        }
        .class-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        .class-description {
            font-size: 0.9em;
            color: #555;
            max-width: 200px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="characterSelectScreen">
        <h1 id="gameTitle">Super Tiny World Simplified</h1>
        <div class="class-container">
            <button id="knightBtn" title="Boosts Red Gems by 50%">Knight (Red Gem Buff)</button>
            <span class="class-description">Durable warrior with enhanced Red Gem damage.</span>
        </div>
        <div class="class-container">
            <button id="mageBtn" title="Boosts Blue Gems by 50%">Mage (Blue Gem Buff)</button>
            <span class="class-description">Mystical caster with boosted Blue Gem effects.</span>
        </div>
        <div class="class-container">
            <button id="rogueBtn" title="Boosts Green Gems by 50%">Rogue (Green Gem Buff)</button>
            <span class="class-description">Swift trickster with powerful Green Gem strikes.</span>
        </div>
    </div>

    <div id="battleScreen">
        <div id="enemyStats">
            <h2>Enemy</h2>
            <p>Name: <span id="enemyName">Grunt Level 1</span></p>
            <p>Health: <span id="enemyHealth">20</span>/<span id="enemyMaxHealth">20</span></p>
            <p>Attack: <span id="enemyAttack">5</span></p>
            <p>Condition: <span id="bossCondition"></span></p>
        </div>
        
        <div id="playerSection">
            <div id="playerStats">
                <h2>Player</h2>
                <p>Class: <span id="playerClass">None</span></p>
                <p>Health: <span id="playerHealth">30</span>/<span id="playerMaxHealth">30</span></p>
                <p>Stamina: <span id="stamina">3</span></p>
                <p>$ZENNY: <span id="zenny">0</span></p>
                <p id="waitBuffIndicator"></p>
            </div>
            
            <div id="handAndActions">
                <div id="actionButtons">
                    <button id="executeBtn" title="Play selected Gems">Execute</button>
                    <button id="endTurnBtn" title="End your turn, enemy attacks">End Turn</button>
                    <button id="discardAndEndTurnBtn" title="Discard selected Gems and end turn">Discard and End Turn</button>
                    <button id="waitBtn" title="Wait for class-specific buff next turn">Wait</button>
                </div>
                
                <div id="hand">
                    <h2>Your Hand</h2>
                </div>
            </div>
        </div>
        
        <div id="deckSizeIndicator">Deck: <span id="deckSize">30</span>/<span id="maxDeckSize">30</span></div>
    </div>
    
    <div id="shopScreen">
        <div id="shopHealth">Health: <span id="shopHealthValue">30</span>/<span id="shopMaxHealthValue">30</span></div>
        <div id="shopZenny">$ZENNY: <span id="shopZennyValue">0</span></div>
        <div id="shopDeckInfo">Deck: <span id="shopDeckSize">30</span>/30 | Discard: <span id="shopDiscardSize">0</span></div>
        <div id="shopSelections">
            <h2>Shop</h2>
            <div id="shopHand">
                <h2>Your Hand</h2>
            </div>
            <button id="heal10" title="Restore 10 health for 5 $ZENNY">Heal 10 health - 5 $ZENNY</button>
            <button id="buyRandomGem" title="Add a random Gem to your deck">Buy Random Gem - 10 $ZENNY</button>
            <button id="discardGem" title="Discard selected Gem for 3 $ZENNY">Discard Selected Gem - +3 $ZENNY</button>
            <button id="continueBtn" title="Proceed to next battle">Continue to next battle</button>
            <div id="upgradeOptions"></div>
        </div>
    </div>
    
    <div id="message"></div>
    
    <script>
        let player = {
            class: null,
            maxHealth: 30,
            health: 30,
            stamina: 3,
            baseStamina: 3,
            zenny: 0,
            damageReduction: 0,
            waitBuff: null
        };

        let enemyLevel = 1;
        const regularEnemies = [
            { type: "Grunt", baseHealth: 20, baseAttack: 5 },
            { type: "Brute", baseHealth: 25, baseAttack: 3 },
            { type: "Striker", baseHealth: 15, baseAttack: 7 }
        ];
        const bossEnemies = [
            { type: "Overlord", baseHealth: 40, baseAttack: 5, condition: "staminaMinusOne" },
            { type: "Twin Fang", baseHealth: 30, baseAttack: 4, condition: "doubleAttack" },
            { type: "Shadow", baseHealth: 25, baseAttack: 8, condition: "healHalf" }
        ];
        let isBossBattle = false;
        let enemy = getEnemy(enemyLevel);
        let enemyStunned = false;

        let baseDeck = {
            // Base Gems
            redAttack: { name: "Red Attack", color: "red", cost: 2, damage: 5 },
            redStrongAttack: { name: "Red Strong Attack", color: "red", cost: 2, damage: 8 }, // Knight-only
            greenAttack: { name: "Green Attack", color: "green", cost: 1, damage: 5 },
            greenQuickAttack: { name: "Green Quick Attack", color: "green", cost: 1, damage: 3, hits: 2 }, // Rogue-only
            greyHeal: { name: "Grey Heal", color: "grey", cost: 1, heal: 5 },
            blueStrongHeal: { name: "Blue Strong Heal", color: "blue", cost: 2, heal: 8 }, // Mage-only
            blueMagicAttack: { name: "Blue Magic Attack", color: "blue", cost: 2, damage: 7 },
            blueShield: { name: "Blue Shield", color: "blue", cost: 1, damageReduction: 0.5 },
            blueStun: { name: "Blue Stun", color: "blue", cost: 2, stun: true }, // Mage-only utility
            // Powerful Action Gems
            redMightyAttack: { name: "Red Mighty Attack", color: "red", cost: 3, damage: 12 },
            greenTripleStrike: { name: "Green Triple Strike", color: "green", cost: 2, damage: 4, hits: 3 },
            blueMegaHeal: { name: "Blue Mega Heal", color: "blue", cost: 3, heal: 12 },
            blueArcaneBlast: { name: "Blue Arcane Blast", color: "blue", cost: 3, damage: 10 }
        };
        const powerfulActionGems = [
            "redMightyAttack", "greenTripleStrike", "blueMegaHeal", "blueArcaneBlast"
        ];
        let deck = [];
        let hand = [];
        let discard = [];
        const maxHandSize = 3;
        const maxDeckSize = 30; // Doubled from 15
        let battleOver = false;
        let selectedGems = new Set();
        let hasActedThisTurn = false;
        let currentScreen = "characterSelect";

        function getEnemy(level) {
            if (level % 3 === 0) {
                const bossIndex = Math.floor((level - 1) / 3) % 3;
                const base = bossEnemies[bossIndex];
                isBossBattle = true;
                return {
                    name: `${base.type} Level ${level}`,
                    maxHealth: base.baseHealth + 3 * (level - 1),
                    health: base.baseHealth + 3 * (level - 1),
                    attack: base.baseAttack + Math.floor((level - 1) / 3),
                    condition: base.condition
                };
            } else {
                const typeIndex = (level - 1) % 3;
                const base = regularEnemies[typeIndex];
                isBossBattle = false;
                return {
                    name: `${base.type} Level ${level}`,
                    maxHealth: base.baseHealth + 3 * (level - 1),
                    health: base.baseHealth + 3 * (level - 1),
                    attack: base.baseAttack + Math.floor((level - 1) / 3),
                    condition: null
                };
            }
        }

        function resetDeck() {
            deck = [];
            // Common Gems for all classes (doubled: 20 total)
            deck.push(
                { ...baseDeck.redAttack, upgradeCount: 0 }, { ...baseDeck.redAttack, upgradeCount: 0 }, 
                { ...baseDeck.redAttack, upgradeCount: 0 }, { ...baseDeck.redAttack, upgradeCount: 0 }, 
                { ...baseDeck.redAttack, upgradeCount: 0 }, { ...baseDeck.redAttack, upgradeCount: 0 }, // 6
                { ...baseDeck.greenAttack, upgradeCount: 0 }, { ...baseDeck.greenAttack, upgradeCount: 0 }, 
                { ...baseDeck.greenAttack, upgradeCount: 0 }, { ...baseDeck.greenAttack, upgradeCount: 0 }, 
                { ...baseDeck.greenAttack, upgradeCount: 0 }, { ...baseDeck.greenAttack, upgradeCount: 0 }, // 6
                { ...baseDeck.greyHeal, upgradeCount: 0 }, { ...baseDeck.greyHeal, upgradeCount: 0 }, 
                { ...baseDeck.greyHeal, upgradeCount: 0 }, { ...baseDeck.greyHeal, upgradeCount: 0 }, 
                { ...baseDeck.greyHeal, upgradeCount: 0 }, { ...baseDeck.greyHeal, upgradeCount: 0 }, // 6
                { ...baseDeck.blueMagicAttack, upgradeCount: 0 }, { ...baseDeck.blueMagicAttack, upgradeCount: 0 } // 2
            );
            // Class-specific Gems (doubled: 10 total)
            if (player.class === "Knight") {
                deck.push(
                    { ...baseDeck.redStrongAttack, upgradeCount: 0 }, { ...baseDeck.redStrongAttack, upgradeCount: 0 }, 
                    { ...baseDeck.redStrongAttack, upgradeCount: 0 }, { ...baseDeck.redStrongAttack, upgradeCount: 0 }, 
                    { ...baseDeck.redStrongAttack, upgradeCount: 0 }, { ...baseDeck.redStrongAttack, upgradeCount: 0 }, // 6
                    { ...baseDeck.greenAttack, upgradeCount: 0 }, { ...baseDeck.greenAttack, upgradeCount: 0 }, // 2
                    { ...baseDeck.greyHeal, upgradeCount: 0 }, { ...baseDeck.greyHeal, upgradeCount: 0 } // 2
                );
            } else if (player.class === "Mage") {
                deck.push(
                    { ...baseDeck.blueStrongHeal, upgradeCount: 0 }, { ...baseDeck.blueStrongHeal, upgradeCount: 0 }, // 2
                    { ...baseDeck.blueStun, upgradeCount: 0 }, { ...baseDeck.blueStun, upgradeCount: 0 }, // 2
                    { ...baseDeck.blueShield, upgradeCount: 0 }, { ...baseDeck.blueShield, upgradeCount: 0 }, // 2
                    { ...baseDeck.greyHeal, upgradeCount: 0 }, { ...baseDeck.greyHeal, upgradeCount: 0 }, // 2
                    { ...baseDeck.greenAttack, upgradeCount: 0 }, { ...baseDeck.greenAttack, upgradeCount: 0 } // 2
                );
            } else if (player.class === "Rogue") {
                deck.push(
                    { ...baseDeck.greenQuickAttack, upgradeCount: 0 }, { ...baseDeck.greenQuickAttack, upgradeCount: 0 }, 
                    { ...baseDeck.greenQuickAttack, upgradeCount: 0 }, { ...baseDeck.greenQuickAttack, upgradeCount: 0 }, 
                    { ...baseDeck.greenQuickAttack, upgradeCount: 0 }, { ...baseDeck.greenQuickAttack, upgradeCount: 0 }, // 6
                    { ...baseDeck.greenAttack, upgradeCount: 0 }, { ...baseDeck.greenAttack, upgradeCount: 0 }, // 2
                    { ...baseDeck.greyHeal, upgradeCount: 0 }, { ...baseDeck.greyHeal, upgradeCount: 0 } // 2
                );
            }
            return shuffle(deck);
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function drawCards(num) {
            const needed = Math.min(num, maxHandSize - hand.length);
            if (needed <= 0) return;
            let drawn = 0;
            while (drawn < needed && (deck.length > 0 || (enemyLevel > 3 && discard.length > 0))) {
                if (deck.length === 0 && enemyLevel > 3) {
                    deck = shuffle(discard.slice());
                    discard = [];
                }
                if (deck.length > 0) {
                    hand.push(deck.pop());
                    drawn++;
                } else {
                    break;
                }
            }
            updateStats();
        }

        function updateHand() {
            const handDiv = document.getElementById("hand");
            while (handDiv.children.length > 1) {
                handDiv.removeChild(handDiv.lastChild);
            }
            hand.forEach((gem, index) => {
                const gemDiv = document.createElement("div");
                gemDiv.className = `gem ${gem.color}`;
                let displayText = `${gem.name} (Cost: ${gem.cost}${gem.damage ? ", Damage: " + gem.damage : gem.heal ? ", Heal: " + gem.heal : gem.stun ? ", Stun" : gem.damageReduction ? ", Shield" : ""}${gem.hits ? ", Hits: " + gem.hits : ""})`;
                
                if (!battleOver || currentScreen !== "shop") {
                    if (selectedGems.has(index)) {
                        if (player.class === "Knight" && gem.color === "red" && gem.damage) {
                            displayText += ` (+50% damage)`;
                        } else if (player.class === "Mage" && gem.color === "blue") {
                            if (gem.heal) displayText += ` (+50% heal)`;
                            else if (gem.damage) displayText += ` (+50% damage)`;
                            else if (gem.damageReduction) displayText += ` (+50% shield)`;
                        } else if (player.class === "Rogue" && gem.color === "green" && gem.damage) {
                            displayText += ` (+50% damage)`;
                        }
                    }
                }
                
                gemDiv.textContent = displayText;
                gemDiv.id = `gem-${index}`;
                gemDiv.onclick = () => toggleGemSelection(index);
                if (selectedGems.has(index)) {
                    gemDiv.classList.add("selected");
                }
                handDiv.appendChild(gemDiv);
            });
        }

        function updateShopHand() {
            const shopHandDiv = document.getElementById("shopHand");
            while (shopHandDiv.children.length > 1) {
                shopHandDiv.removeChild(shopHandDiv.lastChild);
            }
            hand.forEach((gem, index) => {
                const gemDiv = document.createElement("div");
                gemDiv.className = `gem ${gem.color}`;
                gemDiv.textContent = `${gem.name} (Cost: ${gem.cost}${gem.damage ? ", Damage: " + gem.damage : gem.heal ? ", Heal: " + gem.heal : gem.stun ? ", Stun" : gem.damageReduction ? ", Shield" : ""}${gem.hits ? ", Hits: " + gem.hits : ""})`;
                gemDiv.id = `shop-gem-${index}`;
                gemDiv.onclick = () => toggleGemSelection(index);
                if (selectedGems.has(index)) {
                    gemDiv.classList.add("selected");
                }
                shopHandDiv.appendChild(gemDiv);
            });
            updateShop();
            updateShopStats();
        }

        function toggleGemSelection(index) {
            if (index < 0 || index >= hand.length) return;
            if (currentScreen === "battle" && !battleOver) {
                if (selectedGems.has(index)) {
                    selectedGems.delete(index);
                } else {
                    selectedGems.add(index);
                }
                updateHand();
            } else if (currentScreen === "shop") {
                selectedGems.clear();
                selectedGems.add(index);
                updateShopHand();
            }
        }

        function updateStats() {
            document.getElementById("playerClass").textContent = player.class || "None";
            document.getElementById("playerHealth").textContent = player.health;
            document.getElementById("playerMaxHealth").textContent = player.maxHealth;
            document.getElementById("stamina").textContent = player.stamina;
            document.getElementById("zenny").textContent = player.zenny;
            document.getElementById("deckSize").textContent = deck.length;
            document.getElementById("maxDeckSize").textContent = maxDeckSize;

            document.getElementById("enemyName").textContent = enemy.name;
            document.getElementById("enemyHealth").textContent = enemy.health;
            document.getElementById("enemyMaxHealth").textContent = enemy.maxHealth;
            document.getElementById("enemyAttack").textContent = enemy.attack;

            const conditionSpan = document.getElementById("bossCondition");
            if (isBossBattle && enemy.condition) {
                switch (enemy.condition) {
                    case "staminaMinusOne": conditionSpan.textContent = "Stamina reduced by 1 each turn"; break;
                    case "doubleAttack": conditionSpan.textContent = "Attacks twice"; break;
                    case "healHalf": conditionSpan.textContent = "Healing halved"; break;
                    default: conditionSpan.textContent = "Unknown condition";
                }
            } else if (enemyStunned) {
                conditionSpan.textContent = "Stunned this turn";
            } else {
                conditionSpan.textContent = "";
            }

            const waitBuffIndicator = document.getElementById("waitBuffIndicator");
            if (player.waitBuff) {
                switch (player.waitBuff.type) {
                    case "damageReduction": waitBuffIndicator.textContent = "Next turn: 50% damage reduction"; break;
                    case "heal": waitBuffIndicator.textContent = "Next turn: +5 heal"; break;
                    case "stamina": waitBuffIndicator.textContent = "Next turn: +1 stamina"; break;
                    default: waitBuffIndicator.textContent = "";
                }
            } else {
                waitBuffIndicator.textContent = "";
            }

            document.getElementById("discardAndEndTurnBtn").disabled = hasActedThisTurn;
            document.getElementById("waitBtn").disabled = hasActedThisTurn;
        }

        function updateShopStats() {
            document.getElementById("shopHealthValue").textContent = player.health;
            document.getElementById("shopMaxHealthValue").textContent = player.maxHealth;
            document.getElementById("shopZennyValue").textContent = player.zenny;
            document.getElementById("shopDeckSize").textContent = deck.length;
            document.getElementById("shopDiscardSize").textContent = discard.length;
        }

        function switchScreen(screen) {
            document.getElementById("characterSelectScreen").style.display = "none";
            document.getElementById("battleScreen").style.display = "none";
            document.getElementById("shopScreen").style.display = "none";
            document.getElementById(screen + "Screen").style.display = "flex";
            currentScreen = screen;
            if (screen === "battle") updateStats();
            if (screen === "shop") {
                updateShopStats();
                updateShopHand();
            }
        }

        function playGem(index) {
            if (battleOver || index < 0 || index >= hand.length) return false;
            const gem = hand[index];
            if (player.stamina >= gem.cost) {
                player.stamina -= gem.cost;
                let effectMultiplier = 1;
                if (player.class === "Knight" && gem.color === "red" && gem.damage) effectMultiplier = 1.5;
                if (player.class === "Mage" && gem.color === "blue" && (gem.heal || gem.damage || gem.damageReduction)) effectMultiplier = 1.5;
                if (player.class === "Rogue" && gem.color === "green" && gem.damage) effectMultiplier = 1.5;

                if (gem.damage) {
                    if (gem.hits) {
                        const hitDamage = Math.floor(gem.damage * effectMultiplier);
                        for (let i = 0; i < gem.hits; i++) {
                            enemy.health -= hitDamage;
                            if (enemy.health < 0) enemy.health = 0;
                        }
                    } else {
                        const damage = Math.floor(gem.damage * effectMultiplier);
                        enemy.health -= damage;
                        if (enemy.health < 0) enemy.health = 0;
                    }
                } else if (gem.heal) {
                    let healAmount = Math.floor(gem.heal * effectMultiplier);
                    if (isBossBattle && enemy.condition === "healHalf") healAmount = Math.floor(healAmount / 2);
                    player.health += healAmount;
                    if (player.health > player.maxHealth) player.health = player.maxHealth;
                } else if (gem.damageReduction) {
                    player.damageReduction = gem.shieldBoost 
                        ? gem.damageReduction * effectMultiplier + gem.shieldBoost 
                        : gem.damageReduction * effectMultiplier;
                } else if (gem.stun) {
                    enemyStunned = true;
                }

                hand.splice(index, 1);
                discard.push(gem);
                selectedGems.delete(index);
                const newSelected = new Set();
                selectedGems.forEach(oldIndex => {
                    if (oldIndex > index) newSelected.add(oldIndex - 1);
                    else if (oldIndex < index) newSelected.add(oldIndex);
                });
                selectedGems = newSelected;
                checkBattleStatus();
                updateStats();
                updateHand();
                if (player.stamina === 0 && !battleOver) {
                    endTurn();
                }
                return true;
            } else {
                document.getElementById("message").textContent = "Not enough stamina!";
                return false;
            }
        }

        function executeSelectedGems() {
            if (battleOver) return;
            if (selectedGems.size === 0) {
                document.getElementById("message").textContent = "Select Gems to execute!";
                return;
            }
            hasActedThisTurn = true;
            const indicesToPlay = Array.from(selectedGems).sort((a, b) => a - b);
            let successCount = 0;
            for (let i = 0; i < indicesToPlay.length; i++) {
                const index = indicesToPlay[i] - successCount;
                if (index >= 0 && index < hand.length) {
                    if (playGem(index)) {
                        successCount++;
                    } else {
                        break;
                    }
                }
            }
            selectedGems.clear();
            document.getElementById("message").textContent = `Executed ${successCount} Gem(s).`;
        }

        function endTurn() {
            if (battleOver) return;
            if (!enemyStunned) {
                let damage = enemy.attack;
                if (player.damageReduction > 0) {
                    damage = Math.floor(damage * (1 - player.damageReduction));
                    player.damageReduction = 0;
                }
                if (player.waitBuff && player.waitBuff.type === "damageReduction") {
                    damage = Math.floor(damage * 0.5);
                    player.waitBuff = null;
                    document.getElementById("message").textContent = "Wait buff applied: 50% damage reduction!";
                }
                if (isBossBattle && enemy.condition === "doubleAttack") {
                    player.health -= damage;
                    if (player.health > 0) player.health -= damage;
                } else {
                    player.health -= damage;
                }
                if (player.health < 0) player.health = 0;
            } else {
                document.getElementById("message").textContent = "Enemy stunned, no attack this turn!";
                enemyStunned = false;
            }
            checkBattleStatus();
            if (!battleOver) {
                let newStamina = isBossBattle && enemy.condition === "staminaMinusOne" 
                    ? Math.max(player.baseStamina - 1, 1) 
                    : player.baseStamina;
                if (player.waitBuff) {
                    if (player.waitBuff.type === "heal") {
                        player.health += player.waitBuff.value;
                        if (player.health > player.maxHealth) player.health = player.maxHealth;
                        document.getElementById("message").textContent = "Wait buff applied: +5 health!";
                        player.waitBuff = null;
                    } else if (player.waitBuff.type === "stamina") {
                        newStamina += player.waitBuff.value;
                        document.getElementById("message").textContent = "Wait buff applied: +1 stamina!";
                        player.waitBuff = null;
                    }
                }
                player.stamina = newStamina;
                drawCards(maxHandSize - hand.length);
            }
            hasActedThisTurn = false;
            updateStats();
            updateHand();
        }

        function discardAndEndTurn() {
            if (battleOver) return;
            if (hasActedThisTurn) {
                document.getElementById("message").textContent = "Cannot discard after another action this turn!";
                return;
            }
            if (selectedGems.size === 0) {
                document.getElementById("message").textContent = "Select Gems to discard!";
                return;
            }
            hasActedThisTurn = true;
            const indicesToDiscard = Array.from(selectedGems).sort((a, b) => b - a);
            const discardedGems = [];
            indicesToDiscard.forEach(index => {
                if (index >= 0 && index < hand.length) {
                    const gem = hand.splice(index, 1)[0];
                    deck.push(gem);
                    discardedGems.push(gem.name);
                }
            });
            deck = shuffle(deck);
            selectedGems.clear();

            if (!enemyStunned) {
                let damage = enemy.attack;
                if (player.damageReduction > 0) {
                    damage = Math.floor(damage * (1 - player.damageReduction));
                    player.damageReduction = 0;
                }
                if (player.waitBuff && player.waitBuff.type === "damageReduction") {
                    damage = Math.floor(damage * 0.5);
                    player.waitBuff = null;
                    document.getElementById("message").textContent = "Wait buff applied: 50% damage reduction!";
                }
                if (isBossBattle && enemy.condition === "doubleAttack") {
                    player.health -= damage;
                    if (player.health > 0) player.health -= damage;
                } else {
                    player.health -= damage;
                }
                if (player.health < 0) player.health = 0;
            } else {
                document.getElementById("message").textContent = "Enemy stunned, no attack this turn!";
                enemyStunned = false;
            }
            checkBattleStatus();
            if (!battleOver) {
                player.stamina = isBossBattle && enemy.condition === "staminaMinusOne" 
                    ? Math.max(player.baseStamina - 1, 1) 
                    : player.baseStamina;
                if (player.waitBuff) {
                    if (player.waitBuff.type === "heal") {
                        player.health += player.waitBuff.value;
                        if (player.health > player.maxHealth) player.health = player.maxHealth;
                        document.getElementById("message").textContent = "Wait buff applied: +5 health!";
                        player.waitBuff = null;
                    } else if (player.waitBuff.type === "stamina") {
                        player.stamina += player.waitBuff.value;
                        document.getElementById("message").textContent = "Wait buff applied: +1 stamina!";
                        player.waitBuff = null;
                    }
                }
                drawCards(maxHandSize - hand.length);
            }
            hasActedThisTurn = false;
            updateStats();
            updateHand();
            document.getElementById("message").textContent = `Discarded ${discardedGems.length} Gem(s) and ended turn.`;
        }

        function wait() {
            if (battleOver) return;
            if (hasActedThisTurn) {
                document.getElementById("message").textContent = "Cannot wait after another action this turn!";
                return;
            }
            hasActedThisTurn = true;
            switch (player.class) {
                case "Knight":
                    player.waitBuff = { type: "damageReduction", value: 0.5 };
                    document.getElementById("message").textContent = "Waiting... 50% damage reduction next turn!";
                    break;
                case "Mage":
                    player.waitBuff = { type: "heal", value: 5 };
                    document.getElementById("message").textContent = "Waiting... +5 heal next turn!";
                    break;
                case "Rogue":
                    player.waitBuff = { type: "stamina", value: 1 };
                    document.getElementById("message").textContent = "Waiting... +1 stamina next turn!";
                    break;
                default:
                    document.getElementById("message").textContent = "No class selected for wait buff!";
                    hasActedThisTurn = false;
                    return;
            }
            updateStats();
        }

        function checkBattleStatus() {
            const messageDiv = document.getElementById("message");
            if (enemy.health <= 0) {
                messageDiv.textContent = `You defeated ${enemy.name}! Earned 10 $ZENNY.`;
                player.zenny += 10;
                battleOver = true;
                switchScreen("shop");
                updateShopHand();
            } else if (player.health <= 0) {
                messageDiv.textContent = `You were defeated by ${enemy.name}! Game Over. Total $ZENNY: ${player.zenny}`;
                battleOver = true;
            } else {
                messageDiv.textContent = "";
            }
        }

        function updateShop() {
            const upgradeOptions = document.getElementById("upgradeOptions");
            upgradeOptions.innerHTML = "";

            if (selectedGems.size === 1) {
                const index = Array.from(selectedGems)[0];
                const gem = hand[index];
                const canUpgrade = (gem.upgradeCount || 0) < 3;

                const damageHealBtn = document.createElement("button");
                damageHealBtn.textContent = "+3 Damage/Heal - 10 $ZENNY";
                damageHealBtn.title = "Increase damage or heal by 3, replace with powerful Gem of same color";
                damageHealBtn.onclick = () => upgradeDamageHeal(index);
                damageHealBtn.disabled = !canUpgrade || player.zenny < 10 || (!gem.damage && !gem.heal);

                const costBtn = document.createElement("button");
                costBtn.textContent = "-1 Cost (min 1) - 10 $ZENNY";
                costBtn.title = "Reduce Gem cost by 1 (minimum 1), replace with powerful Gem of same color";
                costBtn.onclick = () => upgradeCost(index);
                costBtn.disabled = !canUpgrade || player.zenny < 10 || gem.cost <= 1;

                const specialBtn = document.createElement("button");
                let specialText = gem.name === "Green Quick Attack" ? "+1 Hit" : 
                                 gem.name === "Blue Shield" ? "+25% Shield" : 
                                 "+2 Damage";
                specialBtn.textContent = `${specialText} - 10 $ZENNY`;
                specialBtn.title = `Add ${specialText} to Gem, replace with powerful Gem of same color`;
                specialBtn.onclick = () => upgradeSpecial(index);
                specialBtn.disabled = !canUpgrade || player.zenny < 10 || (specialText === "+2 Damage" && !gem.damage);

                upgradeOptions.appendChild(damageHealBtn);
                upgradeOptions.appendChild(costBtn);
                upgradeOptions.appendChild(specialBtn);
            }

            document.getElementById("buyRandomGem").disabled = player.zenny < 10 || deck.length >= maxDeckSize;
            document.getElementById("discardGem").disabled = selectedGems.size === 0;
        }

        function replaceWithPowerfulGem(index) {
            const originalGem = hand[index];
            const matchingGems = powerfulActionGems.filter(key => baseDeck[key].color === originalGem.color);
            if (matchingGems.length === 0) {
                const randomGemKey = powerfulActionGems[Math.floor(Math.random() * powerfulActionGems.length)];
                const newGem = { ...baseDeck[randomGemKey], upgradeCount: 0 };
                hand[index] = newGem;
                return newGem.name;
            }
            const randomGemKey = matchingGems[Math.floor(Math.random() * matchingGems.length)];
            const newGem = { ...baseDeck[randomGemKey], upgradeCount: 0 };
            hand[index] = newGem;
            return newGem.name;
        }

        function upgradeDamageHeal(index) {
            if (index < 0 || index >= hand.length) return;
            const gem = hand[index];
            if (player.zenny < 10) {
                document.getElementById("message").textContent = "Not enough $ZENNY!";
                return;
            }
            if ((gem.upgradeCount || 0) >= 3) {
                document.getElementById("message").textContent = "Max upgrades reached!";
                return;
            }
            if (!gem.damage && !gem.heal) {
                document.getElementById("message").textContent = "Cannot upgrade damage/heal on this Gem!";
                return;
            }
            player.zenny -= 10;
            gem.upgradeCount = (gem.upgradeCount || 0) + 1;
            if (gem.damage) gem.damage += 3;
            else if (gem.heal) gem.heal += 3;
            const newGemName = replaceWithPowerfulGem(index);
            document.getElementById("message").textContent = `${gem.name} upgraded with +3 Damage/Heal, replaced with ${newGemName}!`;
            updateStats();
            updateShopHand();
        }

        function upgradeCost(index) {
            if (index < 0 || index >= hand.length) return;
            const gem = hand[index];
            if (player.zenny < 10) {
                document.getElementById("message").textContent = "Not enough $ZENNY!";
                return;
            }
            if ((gem.upgradeCount || 0) >= 3) {
                document.getElementById("message").textContent = "Max upgrades reached!";
                return;
            }
            if (gem.cost <= 1) {
                document.getElementById("message").textContent = "Cost cannot be reduced below 1!";
                return;
            }
            player.zenny -= 10;
            gem.upgradeCount = (gem.upgradeCount || 0) + 1;
            gem.cost -= 1;
            const newGemName = replaceWithPowerfulGem(index);
            document.getElementById("message").textContent = `${gem.name} upgraded with -1 Cost, replaced with ${newGemName}!`;
            updateStats();
            updateShopHand();
        }

        function upgradeSpecial(index) {
            if (index < 0 || index >= hand.length) return;
            const gem = hand[index];
            if (player.zenny < 10) {
                document.getElementById("message").textContent = "Not enough $ZENNY!";
                return;
            }
            if ((gem.upgradeCount || 0) >= 3) {
                document.getElementById("message").textContent = "Max upgrades reached!";
                return;
            }
            player.zenny -= 10;
            gem.upgradeCount = (gem.upgradeCount || 0) + 1;
            let success = false;
            if (gem.name === "Green Quick Attack") {
                gem.hits = (gem.hits || 2) + 1;
                success = true;
            } else if (gem.name === "Blue Shield") {
                gem.shieldBoost = (gem.shieldBoost || 0) + 0.25;
                success = true;
            } else if (gem.damage) {
                gem.damage += 2;
                success = true;
            }
            if (success) {
                const newGemName = replaceWithPowerfulGem(index);
                document.getElementById("message").textContent = `${gem.name} upgraded with special effect, replaced with ${newGemName}!`;
            } else {
                document.getElementById("message").textContent = "No special upgrade available!";
                player.zenny += 10;
                gem.upgradeCount -= 1;
            }
            updateStats();
            updateShopHand();
        }

        function buyRandomGem() {
            if (player.zenny < 10) {
                document.getElementById("message").textContent = "Not enough $ZENNY!";
                return;
            }
            if (deck.length >= maxDeckSize) {
                document.getElementById("message").textContent = "Deck is full!";
                return;
            }
            const gemTypes = Object.keys(baseDeck);
            const randomGemKey = gemTypes[Math.floor(Math.random() * gemTypes.length)];
            const newGem = { ...baseDeck[randomGemKey], upgradeCount: 0 };
            deck.push(newGem);
            player.zenny -= 10;
            document.getElementById("message").textContent = `Bought ${newGem.name} for 10 $ZENNY!`;
            updateStats();
            updateShopStats();
            updateShopHand();
        }

        function discardGem() {
            if (selectedGems.size !== 1) {
                document.getElementById("message").textContent = "Select exactly one Gem to discard!";
                return;
            }
            const index = Array.from(selectedGems)[0];
            if (index < 0 || index >= hand.length) return;
            const gem = hand.splice(index, 1)[0];
            discard.push(gem);
            player.zenny += 3;
            selectedGems.clear();
            document.getElementById("message").textContent = `Discarded ${gem.name} for 3 $ZENNY!`;
            updateStats();
            updateShopStats();
            updateShopHand();
        }

        function heal10() {
            if (player.zenny >= 5) {
                player.zenny -= 5;
                let healAmount = 10;
                if (isBossBattle && enemy.condition === "healHalf") healAmount = Math.floor(healAmount / 2);
                player.health += healAmount;
                if (player.health > player.maxHealth) player.health = player.maxHealth;
                updateStats();
                updateShopHand();
                document.getElementById("message").textContent = `Healed ${healAmount} health!`;
            } else {
                document.getElementById("message").textContent = "Not enough $ZENNY!";
            }
        }

        function startBattle() {
            if (deck.length === 0 && discard.length === 0 && hand.length === 0) {
                deck = resetDeck();
            }
            enemy.health = enemy.maxHealth;
            battleOver = false;
            player.stamina = player.baseStamina;
            player.damageReduction = 0;
            player.waitBuff = null;
            enemyStunned = false;
            drawCards(maxHandSize - hand.length);
            hasActedThisTurn = false;
            selectedGems.clear();
            updateHand();
            updateStats();
            switchScreen("battle");
        }

        function nextBattle() {
            enemyLevel++;
            enemy = getEnemy(enemyLevel);
            startBattle();
        }

        function startGameWithClass(playerClass) {
            player.class = playerClass;
            deck = resetDeck();
            drawCards(maxHandSize);
            startBattle();
        }

        switchScreen("characterSelect");

        document.getElementById("knightBtn").onclick = () => startGameWithClass("Knight");
        document.getElementById("mageBtn").onclick = () => startGameWithClass("Mage");
        document.getElementById("rogueBtn").onclick = () => startGameWithClass("Rogue");
        document.getElementById("executeBtn").onclick = executeSelectedGems;
        document.getElementById("endTurnBtn").onclick = endTurn;
        document.getElementById("discardAndEndTurnBtn").onclick = discardAndEndTurn;
        document.getElementById("waitBtn").onclick = wait;
        document.getElementById("heal10").onclick = heal10;
        document.getElementById("buyRandomGem").onclick = buyRandomGem;
        document.getElementById("discardGem").onclick = discardGem;
        document.getElementById("continueBtn").onclick = nextBattle;
    </script>
</body>
</html>
